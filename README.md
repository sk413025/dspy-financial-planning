# DSPy Financial Planning System

ä¸€å€‹ä½¿ç”¨ DSPy æ¡†æ¶æ§‹å»ºçš„å®Œæ•´é‡‘èè¦åŠƒç³»çµ±ï¼Œå±•ç¤ºäº†å¦‚ä½•é€éè²æ˜å¼ç¨‹å¼è¨­è¨ˆä¾†è‡ªå‹•åŒ– prompt ç”Ÿæˆèˆ‡å„ªåŒ–ã€‚

## ğŸ’¡ ç‚ºä»€éº¼é¸æ“‡é€™å€‹å°ˆæ¡ˆï¼Ÿ

**å‚³çµ± LLM æ‡‰ç”¨é–‹ç™¼çš„ç—›é»ï¼š**
- æ‰‹å‹•æ’°å¯«å’Œèª¿æ•´ promptï¼Œè€—æ™‚ä¸”å®¹æ˜“å‡ºéŒ¯
- é›£ä»¥ç³»çµ±åŒ–åœ°å„ªåŒ– prompt æ•ˆæœ
- ç¼ºä¹çµæ§‹åŒ–çš„è¼¸å…¥è¼¸å‡ºé©—è­‰
- å¯¦é©—è¨˜éŒ„å’Œçµæœæ¯”è¼ƒå›°é›£

**DSPy å¦‚ä½•è§£æ±ºé€™äº›å•é¡Œï¼š**
- ğŸ¯ **è²æ˜å¼è¨­è¨ˆ**: åªéœ€å®šç¾©è¼¸å…¥è¼¸å‡ºçµæ§‹ï¼Œprompt è‡ªå‹•ç”Ÿæˆ
- ğŸ§  **æ™ºèƒ½å„ªåŒ–**: è‡ªå‹•æ·»åŠ æ¨ç†æ­¥é©Ÿä¸¦åŸºæ–¼ç¯„ä¾‹å­¸ç¿’å„ªåŒ–
- ğŸ“Š **ç³»çµ±åŒ–æ¯”è¼ƒ**: å…§å»ºä¸‰ç¨®æ–¹æ³•æ¯”è¼ƒï¼ˆPredict vs ChainOfThought vs Few-Shotï¼‰
- ğŸ“ **å®Œæ•´è¨˜éŒ„**: è‡ªå‹•è¨˜éŒ„æ‰€æœ‰å¯¦é©—æ•¸æ“šä¾›åˆ†æ

## ğŸ¯ æœ¬å°ˆæ¡ˆå±•ç¤ºå…§å®¹

### 1. DSPy æ ¸å¿ƒæ¦‚å¿µ
- **Signature å®šç¾©**: å¦‚ä½•ç”¨é¡å‹æç¤ºå®šç¾© LLM ä»»å‹™
- **è‡ªå‹• Prompt ç”Ÿæˆ**: DSPy å¦‚ä½•å°‡ Signature è½‰æ›ç‚ºçµæ§‹åŒ– prompt
- **ä¸‰ç¨®å„ªåŒ–æ–¹æ³•**: å¾åŸºç¤åˆ°é€²éšçš„è‡ªå‹•å„ªåŒ–æŠ€è¡“

### 2. å¯¦éš›æ‡‰ç”¨å ´æ™¯
- **é€€ä¼‘é¢¨éšªè©•ä¼°**: ä½¿ç”¨ Monte Carlo æ¨¡æ“¬é€²è¡Œè²¡å‹™è¦åŠƒ
- **è‡ªç„¶èªè¨€æŸ¥è©¢**: å°‡äººé¡èªè¨€è½‰æ›ç‚ºçµæ§‹åŒ–åƒæ•¸
- **å°ˆå®¶å»ºè­°ç”Ÿæˆ**: æ ¹æ“šè²¡å‹™ç‹€æ³æä¾›å€‹äººåŒ–å»ºè­°

### 3. å®Œæ•´é–‹ç™¼æµç¨‹
- **å¯¦é©—è¿½è¹¤**: è©³ç´°è¨˜éŒ„æ¯æ¬¡å¯¦é©—çš„åƒæ•¸å’Œçµæœ
- **æ•ˆæœæ¯”è¼ƒ**: é‡åŒ–åˆ†æä¸åŒæ–¹æ³•çš„è¡¨ç¾å·®ç•°
- **å¯è¦–åŒ–åˆ†æ**: åœ–è¡¨å±•ç¤ºæ¨¡æ“¬çµæœå’Œè¶¨å‹¢

## ğŸš€ å¿«é€Ÿé–‹å§‹

### æ­¥é©Ÿ 1: ç’°å¢ƒè¨­ç½®

```bash
# è¤‡è£½å°ˆæ¡ˆ
git clone https://github.com/sk413025/dspy-financial-planning.git
cd dspy-financial-planning

# å®‰è£ä¾è³´
pip install dspy-ai numpy matplotlib pandas

# è¨­ç½® API Key
cp config.example.py config.py
# ç·¨è¼¯ config.pyï¼Œå¡«å…¥æ‚¨çš„ OpenAI API key
```

### æ­¥é©Ÿ 2: é«”é©— DSPy Prompt å„ªåŒ–

é‹è¡Œä¸»è¦æ¼”ç¤ºï¼Œçœ‹çœ‹ DSPy å¦‚ä½•è‡ªå‹•ç”Ÿæˆå’Œå„ªåŒ– promptï¼š

```bash
python demo_prompt_optimization.py
```

**æ‚¨å°‡çœ‹åˆ°ï¼š**
```
ğŸ¯ dspy Prompt å„ªåŒ–å®Œæ•´å¯¦æˆ°æ¼”ç¤º
================================================================================
æœ¬æ¬¡æ¼”ç¤ºå°‡å±•ç¤ºï¼š
1. ğŸ“‹ åŸºç¤ Prompt è‡ªå‹•ç”Ÿæˆ
2. ğŸ§  ChainOfThought æ¨ç†å¢å¼·  
3. ğŸ“š Few-Shot ç¯„ä¾‹å­¸ç¿’å„ªåŒ–
4. ğŸ“Š ä¸‰ç¨®æ–¹å¼çš„çµæœå°æ¯”
================================================================================

âœ… åŸºç¤ç‰ˆæœ¬çµæœ:
ğŸ¯ é¢¨éšªç­‰ç´š: ä¸­é¢¨éšª
ğŸ’° å»ºè­°å„²è“„: å»ºè­°æ¯æœˆå„²è“„ç´„ 2.5 è¬å°å¹£
ğŸ“‹ ç­–ç•¥: è€ƒæ…®å°‡è³‡é‡‘åˆ†æ•£æŠ•è³‡æ–¼è‚¡ç¥¨å’Œå‚µåˆ¸ï¼Œä»¥å¹³è¡¡é¢¨éšªå’Œå›å ±...

ğŸ§  ChainOfThought ç‰ˆæœ¬çµæœ:
ğŸ¯ é¢¨éšªç­‰ç´š: ä¸­é¢¨éšª  
ğŸ’° å»ºè­°å„²è“„: å»ºè­°æ¯æœˆå„²è“„é‡‘é¡ç´„ç‚º3è¬å°å¹£
ğŸ“‹ ç­–ç•¥: å»ºè­°æ‚¨å°‡æ¯æœˆçš„å„²è“„é‡‘é¡è¨­å®šç‚º3è¬å°å¹£...

ğŸ§  æ¨ç†éç¨‹:
æ‚¨ç›®å‰35æ­²ï¼Œæ“æœ‰200è¬å°å¹£çš„å­˜æ¬¾ï¼Œæœˆæ”¶å…¥ç‚º8è¬å°å¹£ï¼Œç›®æ¨™é€€ä¼‘å¹´é½¡ç‚º65æ­²...

ğŸ“Š å®Œæ•´æ¼”ç¤ºæ—¥èªŒå·²ä¿å­˜åˆ°: logs/session_20250630_185304.jsonl
```

### æ­¥é©Ÿ 3: è‡ªç„¶èªè¨€æŸ¥è©¢

ç”¨è‡ªç„¶èªè¨€æå•ï¼Œç³»çµ±æœƒè‡ªå‹•è§£æä¸¦é‹è¡Œ Monte Carlo æ¨¡æ“¬ï¼š

```bash
python pipeline/run.py "å¦‚æœæˆ‘25å¹´å¾Œé€€ä¼‘ï¼ŒæœŸæœ›å ±é…¬ç‡6%ï¼Œæ³¢å‹•åº¦12%ï¼Œæ¯å¹´èŠ±è²»80è¬ï¼Œç›®å‰æœ‰200è¬å­˜æ¬¾ï¼Œç ´ç”¢æ©Ÿç‡æ˜¯å¤šå°‘ï¼Ÿ"
```

**çµæœï¼š**
```
Parsing query: å¦‚æœæˆ‘25å¹´å¾Œé€€ä¼‘ï¼ŒæœŸæœ›å ±é…¬ç‡6%ï¼Œæ³¢å‹•åº¦12%...

Parsed parameters:
  yrs: 25
  return_mu: 6.0
  return_sigma: 12.0
  spend: 800000.0
  init_net: 2000000.0

Running Monte Carlo simulation...

Results:
{
  "bankruptcy_probability": 89.2,
  "meets_goal": false,
  "final_balance_mean": 1250000.0
}
```

### æ­¥é©Ÿ 4: æŸ¥çœ‹è©³ç´°å¯¦é©—è¨˜éŒ„

ä½¿ç”¨æˆ‘å€‘çš„æ—¥èªŒæŸ¥çœ‹å·¥å…·ä¾†åˆ†æå¯¦é©—çµæœï¼š

```bash
python view_logs.py
```

é€™æœƒé¡¯ç¤ºæ‰€æœ‰å¯ç”¨çš„æ—¥èªŒæª”æ¡ˆï¼Œç„¶å¾Œï¼š

```bash
python view_logs.py session_20250630_185304.jsonl
```

**æ‚¨å°‡çœ‹åˆ°å®Œæ•´çš„çµæ§‹åŒ–å ±å‘Šï¼š**
- ğŸ“ Signature å®šç¾©å’Œè‡ªå‹•ç”Ÿæˆçš„ prompt
- ğŸ§ª ä¸‰ç¨®æ–¹æ³•çš„æ¸¬è©¦åƒæ•¸å’Œçµæœ
- ğŸ“š Few-Shot è¨“ç·´ç¯„ä¾‹
- ğŸ“Š è©³ç´°çš„çµæœæ¯”è¼ƒåˆ†æ
- ğŸ’¡ é—œéµæ´å¯Ÿå’Œå»ºè­°

## ğŸ”¬ æ·±å…¥ç†è§£ DSPy

### DSPy Signature: ä»»å‹™å®šç¾©çš„æ ¸å¿ƒ

```python
class RetirementRisk(dspy.Signature):
    """è©•ä¼°é€€ä¼‘é¢¨éšªä¸¦æä¾›å»ºè­°"""
    
    # è¼¸å…¥æ¬„ä½
    age: int = dspy.InputField(desc="ç•¶å‰å¹´é½¡")
    savings: float = dspy.InputField(desc="ç•¶å‰å­˜æ¬¾é‡‘é¡(è¬å°å¹£)")
    monthly_income: float = dspy.InputField(desc="æœˆæ”¶å…¥(å°å¹£)")
    
    # è¼¸å‡ºæ¬„ä½  
    risk_level: str = dspy.OutputField(desc="é¢¨éšªç­‰ç´š: ä½é¢¨éšª/ä¸­é¢¨éšª/é«˜é¢¨éšª")
    monthly_save_needed: str = dspy.OutputField(desc="å»ºè­°æ¯æœˆå„²è“„é‡‘é¡")
    strategy: str = dspy.OutputField(desc="å…·é«”é€€ä¼‘ç­–ç•¥å»ºè­°")
```

**DSPy è‡ªå‹•ç”Ÿæˆçš„ Prompt:**
```
è©•ä¼°é€€ä¼‘é¢¨éšªä¸¦æä¾›å»ºè­°

---

Follow the following format.

Age: ç•¶å‰å¹´é½¡
Savings: ç•¶å‰å­˜æ¬¾é‡‘é¡(è¬å°å¹£)
Monthly Income: æœˆæ”¶å…¥(å°å¹£)
Risk Level: é¢¨éšªç­‰ç´š: ä½é¢¨éšª/ä¸­é¢¨éšª/é«˜é¢¨éšª
Monthly Save Needed: å»ºè­°æ¯æœˆå„²è“„é‡‘é¡
Strategy: å…·é«”é€€ä¼‘ç­–ç•¥å»ºè­°

---

Age: 35
Savings: 200.0
Monthly Income: 80000
Risk Level:
```

### ä¸‰ç¨®å„ªåŒ–æ–¹æ³•æ¯”è¼ƒ

| æ–¹æ³• | ç‰¹é» | é©ç”¨å ´æ™¯ | çµæœå“è³ª |
|------|------|----------|----------|
| **Predict** | ç°¡å–®ç›´æ¥ | å¿«é€ŸåŸå‹ | åŸºç¤ |
| **ChainOfThought** | è‡ªå‹•æ¨ç† | è¤‡é›œé‚è¼¯ | æ›´å¥½ |
| **Few-Shot** | ç¯„ä¾‹å­¸ç¿’ | ä¸€è‡´æ€§è¦æ±‚ | æœ€ä½³ |

### å¯¦é©—è¨˜éŒ„ç³»çµ±

æ‰€æœ‰å¯¦é©—éƒ½æœƒè‡ªå‹•è¨˜éŒ„åˆ° JSON æ ¼å¼ï¼ŒåŒ…å«ï¼š

```json
{
  "id": 1,
  "timestamp": "2025-06-30T18:53:04",
  "intermediate": {
    "steps": [/* åŸ·è¡Œæ­¥é©Ÿ */],
    "parameters": {/* æ¸¬è©¦åƒæ•¸ */},
    "predictions": [/* é æ¸¬çµæœ */],
    "training_examples": {/* è¨“ç·´ç¯„ä¾‹ */},
    "comparison": {/* çµæœæ¯”è¼ƒ */}
  },
  "output": {
    "demo_summary": {/* ç¸½çµåˆ†æ */}
  }
}
```

## ğŸ“ å°ˆæ¡ˆçµæ§‹è©³è§£

```
â”œâ”€â”€ config.example.py          # API key é…ç½®ç¯„æœ¬
â”œâ”€â”€ demo_prompt_optimization.py # ä¸»è¦æ¼”ç¤ºç¨‹å¼
â”œâ”€â”€ view_logs.py               # æ—¥èªŒæŸ¥çœ‹å·¥å…·
â”‚
â”œâ”€â”€ examples/                  # DSPy ç¯„ä¾‹ç¨‹å¼
â”‚   â”œâ”€â”€ dspy_prompt_engineering.py    # Prompt å·¥ç¨‹æŠ€è¡“
â”‚   â”œâ”€â”€ inspect_dspy_prompts.py       # Prompt å…§éƒ¨çµæ§‹
â”‚   â””â”€â”€ prompt_transformation_demo.py # è½‰æ›éç¨‹å±•ç¤º
â”‚
â”œâ”€â”€ finance/
â”‚   â””â”€â”€ core.py               # è²¡å‹™æ•¸æ“šçµæ§‹
â”‚
â”œâ”€â”€ pipeline/
â”‚   â””â”€â”€ run.py                # è‡ªç„¶èªè¨€æŸ¥è©¢è™•ç†å™¨
â”‚
â”œâ”€â”€ prompts/
â”‚   â””â”€â”€ retire.py             # é€€ä¼‘è¦åŠƒ DSPy æ¨¡çµ„
â”‚
â”œâ”€â”€ simulation/
â”‚   â””â”€â”€ monte_carlo.py        # Monte Carlo æ¨¡æ“¬å¼•æ“
â”‚
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ logger.py             # å¯¦é©—è¨˜éŒ„ç³»çµ±
â”‚   â””â”€â”€ visualizer.py         # æ•¸æ“šå¯è¦–åŒ–å·¥å…·
â”‚
â””â”€â”€ logs/                     # è‡ªå‹•ç”Ÿæˆçš„å¯¦é©—è¨˜éŒ„
    â”œâ”€â”€ session_*.jsonl       # è©³ç´°å¯¦é©—æ—¥èªŒ
    â””â”€â”€ summary_*.json        # ç¸½çµå ±å‘Š
```

## ğŸ¯ å­¸ç¿’è·¯å¾‘å»ºè­°

### åˆå­¸è€…
1. å…ˆé‹è¡Œ `demo_prompt_optimization.py` äº†è§£åŸºæœ¬æ¦‚å¿µ
2. æŸ¥çœ‹ `examples/inspect_dspy_prompts.py` ç†è§£ Prompt ç”Ÿæˆæ©Ÿåˆ¶
3. å˜—è©¦ä¿®æ”¹ Signature å®šç¾©ï¼Œè§€å¯Ÿ Prompt è®ŠåŒ–

### é€²éšä½¿ç”¨è€…
1. ç ”ç©¶ `pipeline/run.py` äº†è§£å®Œæ•´çš„æ‡‰ç”¨æµç¨‹
2. åˆ†æ `logs/` ä¸­çš„å¯¦é©—è¨˜éŒ„ï¼Œç†è§£ä¸åŒæ–¹æ³•çš„æ•ˆæœå·®ç•°
3. ä½¿ç”¨ `utils/visualizer.py` å‰µå»ºè‡ªå·±çš„åˆ†æåœ–è¡¨

### é–‹ç™¼è€…
1. æ“´å±• `prompts/retire.py` æ·»åŠ æ–°çš„ Signature
2. ä¿®æ”¹ `utils/logger.py` å¢åŠ è‡ªå®šç¾©çš„è¨˜éŒ„åŠŸèƒ½
3. é›†æˆåˆ°æ‚¨è‡ªå·±çš„ LLM æ‡‰ç”¨ä¸­

## ğŸ”§ é€²éšåŠŸèƒ½

### è‡ªå®šç¾©è©•ä¼°æŒ‡æ¨™

```python
def custom_metric(example, prediction, trace=None):
    """è‡ªå®šç¾©è©•ä¼°å‡½æ•¸"""
    # æª¢æŸ¥é¢¨éšªç­‰ç´šæº–ç¢ºæ€§
    risk_correct = prediction.risk_level == example.risk_level
    
    # æª¢æŸ¥å»ºè­°åˆç†æ€§
    advice_quality = len(prediction.strategy) > 20
    
    return int(risk_correct and advice_quality)
```

### æ‰¹é‡å¯¦é©—åˆ†æ

```python
from utils.logger import ExperimentLogger

# è¼‰å…¥å¤šå€‹å¯¦é©—è¨˜éŒ„
logger = ExperimentLogger()
df = logger.get_dataframe()

# åˆ†æè¶¨å‹¢
success_rate = df['success'].mean()
avg_duration = df['duration_ms'].mean()
```

## ğŸ¤ è²¢ç»æŒ‡å—

1. Fork é€™å€‹å°ˆæ¡ˆ
2. å‰µå»ºåŠŸèƒ½åˆ†æ”¯: `git checkout -b feature-name`
3. æäº¤è®Šæ›´: `git commit -am 'Add feature'`
4. æ¨é€åˆ°åˆ†æ”¯: `git push origin feature-name`
5. æäº¤ Pull Request

## ğŸ“š ç›¸é—œè³‡æº

- [DSPy å®˜æ–¹æ–‡æª”](https://github.com/stanfordnlp/dspy)
- [Monte Carlo æ¨¡æ“¬åŸç†](https://en.wikipedia.org/wiki/Monte_Carlo_method)
- [OpenAI API æ–‡æª”](https://platform.openai.com/docs)

## ğŸ‰ ç¸½çµ

é€™å€‹å°ˆæ¡ˆå±•ç¤ºäº† DSPy å¦‚ä½•é©å‘½æ€§åœ°ç°¡åŒ– LLM æ‡‰ç”¨é–‹ç™¼ï¼š

- âœ… **é›¶æ‰‹å‹• Prompt**: åªéœ€å®šç¾©çµæ§‹ï¼ŒPrompt è‡ªå‹•ç”Ÿæˆ
- âœ… **è‡ªå‹•å„ªåŒ–**: ç³»çµ±åŒ–åœ°æ”¹é€² LLM è¡¨ç¾
- âœ… **å®Œæ•´è¿½è¹¤**: æ¯å€‹å¯¦é©—éƒ½æœ‰è©³ç´°è¨˜éŒ„
- âœ… **å¯¦ç”¨æ¡ˆä¾‹**: çœŸå¯¦çš„é‡‘èè¦åŠƒæ‡‰ç”¨å ´æ™¯

**ç«‹å³é–‹å§‹é«”é©— DSPy çš„å¼·å¤§åŠŸèƒ½å§ï¼** ğŸš€

---

ä½¿ç”¨ â¤ï¸ å’Œ [DSPy](https://github.com/stanfordnlp/dspy) æ§‹å»º